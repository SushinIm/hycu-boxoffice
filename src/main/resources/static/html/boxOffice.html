<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="../js/util.js"></script>
  <title>박스오피스</title>
</head>
<body>
<div id="header">
  <label for="startDate">From</label> <input type="date" id="startDate"/>
  ~
  <label for="endDate">To</label> <input type="date" id="endDate"/>
  <input type="button" value="조회" id="search"/>
</div>
<hr />
<div id="wrap">
  <div id="nav"></div>
  <div id="chart"></div>
</div>
<div id="footer">
</div>
</body>
<script>
  const setMovieChart = (boxOffice) => {
    const chartArea = d3.select("body > div#wrap > div#chart");
    chartArea.select("*").remove();
    const movieData = boxOffice.filter(movie => boxOffice.movieName === movie.movieName);
      //TODO 순위
      //TODO 매출
      //TODO 관객
      //TODO 상영
      //TODO 날짜별로 꺾은선 그래프?
  }

  const setMovieNameList = (data) => {
    const navArea = d3.select("body > div#wrap > div#nav");
    navArea.select("*").remove();
    data.forEach(boxOffice => {
      navArea.append("p").append("a").text(boxOffice.movieName).addEventListener("click", () =>
          setMovieChart(boxOffice));
    })
  }

  const setBoxOfficeChart = (data) => {
    const chartArea = d3.select("body > div#wrap > div#chart");
    chartArea.select("*").remove();
    data.forEach(boxOffice => {
      let chartBox = chartArea.append("svg")
      .attr("width", 1000)
      .attr("height", 500);

      chartBox.append('line')
    })
  }

  window.onload = () => {
    const requestUrl = "http://localhost:8080/api/box-office";
    let today = new Date();
    let thisYear = today.getFullYear();
    let thisMonth = today.getMonth() + 1;
    let thisDate = today.getDate();
    document.querySelector("#startDate").value = `${thisYear}-${digit2(thisMonth-1)}-${digit2(thisDate)}`;
    document.querySelector("#endDate").value = `${thisYear}-${digit2(thisMonth)}-${digit2(thisDate)}`;
    document.querySelector("#search").addEventListener("click", () => {
      let requestUri = requestUrl;
      let startDate = document.querySelector("#startDate").value;
      let endDate = document.querySelector("#endDate").value;

      requestUri += "?startDate=" + (startDate ? startDate : "");
      requestUri += "&endDate=" + (endDate ? endDate : "");

      if (startDate && endDate) {
        fetch(requestUri)
        .then(res => res.json())
        .then(responseData => {
          console.log(responseData);
          setMovieNameList(responseData);
          setBoxOfficeChart(responseData);
        });
      } else {
        alert("검색 기준 날짜 범위를 설정해 주십시오.");
      }
    });
  }
</script>
</html>